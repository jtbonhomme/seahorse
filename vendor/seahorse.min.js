/*! seahorse - v0.2.6 - 2016-06-18 */
!function(a){"use strict";var b=require("fs"),c=require("throttle"),d=require("util"),e=25e4,f={_debug:!1,_logs:!1,_cors:!0,_proxy:!1,_th:null,_bps:e,_getExtension:function(a){var b=a.lastIndexOf(".");return 0>b?"":a.substr(b)},_setRate:function(a){this._th&&this._th.setBps(a),this._bps=parseInt(a)},_getRate:function(){return this._bps},_sendfile:function(a,e){var g=b.createReadStream(a),h=this;this._th=new c(this._bps),g.on("open",function(){f._debug&&d.log("[info] open "+a),g.pipe(h._th).pipe(e)}),g.on("data",function(a){f._debug&&d.log("[info] read a chunk  :"+a.length+" bytes")}),g.on("close",function(){f._debug&&d.log("closed "+a)}),g.on("error",function(a){console.log("error from reading stream "+a.toString()),e.end(a)})},_allowCrossDomain:function(a,b,c){b.header("Access-Control-Allow-Origin","*"),b.header("Access-Control-Allow-Methods","GET,PUT,POST,DELETE"),b.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),b.header("Seahorse-version","0.1.0"),"OPTIONS"==a.method?b.send(200):c()}};a.utils=f}(this),function(a,b){"use strict";var c=require("util"),d=require("path"),e=require("fs"),f={config:[],getFilesizeInBytes:function(a){var b=e.statSync(a),c=b.size;return c},checkConfig:function(a){try{{JSON.stringify(a)}if(!1==a instanceof Array)throw"object is not an array";a.forEach(function(a,b){if("undefined"==typeof a.httpRequest||"undefined"==typeof a.httpResponse)throw"["+b+"] httpResponse or httpRequest missing";if("undefined"==typeof a.httpRequest.method||"undefined"==typeof a.httpRequest.path)throw"["+b+"] method or path is missing in httpRequest key";if("undefined"==typeof a.httpResponse.statusCode)throw"["+b+"] statusCode is missing in httpResponse key";if("GET"===a.httpRequest.method.toUpperCase()&&404!=a.httpResponse.statusCode&&"undefined"==typeof a.httpResponse.body&&"undefined"==typeof a.httpResponse.file&&"undefined"==typeof a.httpResponse.static)throw"["+b+"] body, file or static are missing in httpResponse key (GET "+a.httpRequest.path+")"})}catch(d){return b._debug&&c.log("[server] input file is not a valid json config file, "+d),!1}return!0},setConfig:function(a){return this.checkConfig(a)?(this.config=a,!0):!1},updateConfig:function(a){var b=this;return this.checkConfig(a)?(a.forEach(function(a){var c=b.config.every(function(b){return b.httpRequest.path===a.httpRequest.path&&b.httpRequest.method===a.httpRequest.method&&b.httpRequest.query===a.httpRequest.query?(b.httpResponse=a.httpResponse,!1):!0});c===!0&&b.config.push(a)}),!0):!1},getConfig:function(){return this.config},_matchPath:function(a,b){if(a.httpRequest.method.toUpperCase()!==b.method.toUpperCase())return!1;if(/^regexp:/.test(a.httpRequest.path)){var c=new RegExp(a.httpRequest.path.split(":")[1]);if(c.test(b.params[0])!==!0)return!1}else if(a.httpRequest.path.replace(/\/$/,"")!==b.params[0].replace(/\/$/,""))return!1;return!0},all:function(a,e){var f={},g=this,h=this.config.some(function(b){if(g._matchPath(b,a)){if("undefined"!=typeof b.httpRequest.query){for(var c in b.httpRequest.query){if("undefined"==typeof a.query[c])return!1;if(b.httpRequest.query[c].toString()!==a.query[c].toString())return!1}return f=b,!0}return f=b,!0}return!1});if(h)setTimeout(function(){if("undefined"!=typeof f.httpResponse.headers&&f.httpResponse.headers.forEach(function(a){a.name&&a.value&&e.setHeader(a.name,a.value)}),e.status("undefined"!=typeof f.httpResponse.statusCode?f.httpResponse.statusCode:200),"undefined"!=typeof f.httpResponse.body)e.send(f.httpResponse.body);else{var c;if("undefined"!=typeof f.httpResponse.file?c=f.httpResponse.file:"undefined"!=typeof f.httpResponse.static&&(c=f.httpResponse.static+a.originalUrl),"undefined"!=typeof c)try{d.resolve(c)!==c&&(c=d.normalize(process.cwd()+"/"+c)),e.setHeader("Content-Length",g.getFilesizeInBytes(c)),b._sendfile(c,e)}catch(h){var i="<html>File '+filename+' not found</html>";e.setHeader("Content-Type","text/html; charset=UTF-8"),e.setHeader("Content-Length",i.length),e.send(i,404)}else e.send("")}},"undefined"==typeof f.httpResponse.delay?1:f.httpResponse.delay);else if(b._debug&&c.log("[warning] request not configured"),"HEAD"===a.method.toUpperCase())e.status(500),e.setHeader("Content-Length",0),e.send();else{var i="<html>Page not found</html>";e.setHeader("Content-Type","text/html; charset=UTF-8"),e.setHeader("Content-Length",i.length),e.send(i,404)}}};a.routes=f}(this,this.utils),function(a,b,c){"use strict";var d=require("express"),e=require("morgan"),f=require("util"),g=require("express-http-proxy"),h=d(),i={_server:null,start:function(a,i){b._cors&&h.use(b._allowCrossDomain),h.use(d.json()),h.use(d.urlencoded()),b._logs&&h.use(e("combined")),b._proxy&&h.use("/proxy",g(function(a){var b=require("url"),c=b.parse(a.url.split("originalUrl=")[1]).host;return c?c:"192.168.1.6"},{forwardPath:function(a){var b=require("url");return b.parse(b.parse(a.url).query.split("originalUrl=")[1]).path},decorateRequest:function(a){return console.log("[proxy] "+a.method+" - "+a.hostname+" - "+a.path),a}})),f.log("[server] start seahorse server on port "+i+(b._logs?" with logs":"")+(b._proxy?" with proxy activated":"")+(b._cors?" (CORS are on)":" (CORS are off)"));var j=[];if(h.get("/stream",function(a,b){a.socket.setTimeout(Number.MAX_VALUE),b.writeHead(200,{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}),j.push(b),f.log("[SSE] new client registered"),b.write("\n")}),h.post("/_rate/:bps",function(a,c){b._setRate(a.params.bps),c.setHeader("Content-Type","application/json; charset=utf-8"),c.send(JSON.stringify({bps:b._getRate()}))}),h.get("/_rate",function(a,c){c.setHeader("Content-Type","application/json; charset=utf-8"),c.send(JSON.stringify({bps:b._getRate()}),200)}),h.post("/stream/:event_name",function(a,b){var c="";try{c=JSON.stringify(a.body)}catch(d){c="ERROR"}var e=(new Date).toLocaleTimeString();j.forEach(function(b){b.write("id: "+e+"\n"),b.write("event: "+a.params.event_name+"\n"),b.write("data: "+c+"\n\n")}),b.send(200)}),h.get("/_config",function(a,b){b.setHeader("Content-Type","application/json; charset=utf-8"),b.send(JSON.stringify(c.getConfig()),200)}),h.post("/_config",function(a,b){var d=a.body;c.setConfig(d,h),b.setHeader("Content-Type","application/json; charset=utf-8"),b.send(JSON.stringify(c.getConfig()))}),h.put("/_config",function(a,b){var d=a.body;c.updateConfig(d,h),b.setHeader("Content-Type","application/json; charset=utf-8"),b.send(JSON.stringify(c.getConfig()),200)}),"undefined"==typeof a)throw"initial config is undefined";c.setConfig(a,h),h.all("*",function(a,d){b._debug&&(f.log("[request] "+a.method+" "+a.originalUrl+"	("+("undefined"!=typeof a.headers["user-agent"]?a.headers["user-agent"]:"unknown")+")"),f.log("[request] [headers] "+JSON.stringify(a.headers))),c.all(a,d)});var k=this;process.on("SIGINT",function(){k.stop()}),this._server=h.listen(i)},stop:function(){f.log("[server] stop seahorse server"),null!==this._server&&this._server.close()}};a.server=i}(this,this.utils,this.routes);